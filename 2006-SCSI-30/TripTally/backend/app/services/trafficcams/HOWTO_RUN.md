# How to Run TripTally Route Optimization System

This guide explains how to run the complete TripTally system with the route optimization feature.

## System Architecture Overview

The system consists of three main components:

1. **Redis** - In-memory data store for CI values and forecasts
2. **CI Processing Service** - Background service that processes traffic images and generates CI forecasts every 2 minutes
3. **FastAPI Backend** - REST API server that includes route optimization endpoints

```
┌─────────────────┐
│  Redis (6379)   │
│  (Storage)      │
└────────┬────────┘
         │
         │ Read/Write CI + Forecasts
         │
┌────────▼────────────────────────────────────────────┐
│  CI Processing Service (Docker Container)           │
│  - Fetches traffic images every 2 min               │
│  - Calculates CI using YOLO + custom algorithm      │
│  - Generates 120-min forecasts using XGBoost        │
│  - Stores in Redis                                  │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  FastAPI Backend (Port 8000)                        │
│  - Route Optimization endpoints                     │
│  - Other TripTally features                         │
│  - Reads CI/forecasts from Redis                    │
└─────────────────────────────────────────────────────┘
```

## Prerequisites

### Required Software
- Python 3.11+
- Docker & Docker Compose
- Git

### Required Environment
- Windows (PowerShell) / macOS / Linux
- At least 4GB RAM
- Internet connection (for fetching traffic images)

## Step 1: Start Redis

Redis stores the CI values and forecasts generated by the CI processing service.

### Using Docker Compose (Recommended)

Navigate to the CI service directory:

```powershell
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend\app\services\trafficcams"
```

Start Redis only:

```powershell
docker-compose up redis -d
```

Verify Redis is running:

```powershell
docker-compose ps
# Should show redis container as "Up"
```

Test Redis connection:

```powershell
docker exec -it triptally-redis redis-cli ping
# Should return: PONG
```

### Using Local Redis (Alternative)

If you have Redis installed locally:

```powershell
redis-server --port 6379
```

## Step 2: Start CI Processing Service

The CI service fetches traffic camera images every 2 minutes, processes them to calculate Congestion Index (CI), and generates 120-minute forecasts.

### Option A: Using Docker (Recommended for Production)

From the same directory (`backend/app/services/trafficcams`):

```powershell
# Build and start the CI service
docker-compose up ci-service -d
```

View logs to ensure it's working:

```powershell
docker-compose logs -f ci-service
```

You should see logs like:
```
[INFO] Starting CI Processing Service...
[INFO] Loaded 90 cameras from cam_id_lat_lon.json
[INFO] Processing cycle 1/∞
[INFO] Fetched 87 camera images
[INFO] Calculated CI for 87 cameras
[INFO] Generated forecasts for next 120 minutes
[INFO] Stored results in Redis
[INFO] Sleeping for 120 seconds...
```

### Option B: Running Locally (Development)

If you want to run the CI service locally instead of Docker:

```powershell
# Navigate to CI service directory
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend\app\services\trafficcams"

# Install Python dependencies (first time only)
pip install -r requirements.txt

# Set environment variables for local development
$env:REDIS_HOST="localhost"
$env:REDIS_PORT="6379"
$env:REDIS_DB="0"
$env:REPOSITORY_TYPE="redis"
$env:FORECASTER_TYPE="auto"
$env:LOOP_INTERVAL="120"

# Run the CI service
python main.py
```

The service will:
1. Load camera metadata from `train/data/cam_id_lat_lon.json` (90 cameras)
2. Fetch traffic images from Singapore LTA API
3. Process images using YOLO to detect vehicles
4. Calculate CI based on vehicle count, area, and motion
5. Generate 120-minute forecasts using XGBoost model
6. Store CI values and forecasts in Redis
7. Repeat every 2 minutes

## Step 3: Start FastAPI Backend

The FastAPI backend provides REST endpoints for route optimization and other TripTally features.

### Navigate to Backend Directory

```powershell
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend"
```

### Install Backend Dependencies (First Time Only)

```powershell
pip install -r requirements.txt
```

### Start the FastAPI Server

#### Option A: Using the Start Script (Recommended)

```powershell
# For PowerShell, run the Python command directly
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### Option B: Manual Command

```powershell
# Set PYTHONPATH (adjust path if needed)
$env:PYTHONPATH = "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend"

# Start server
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

You should see output like:
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345] using StatReload
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### Access API Documentation

Open your browser and navigate to:
- **Interactive API Docs**: http://localhost:8000/docs
- **Alternative Docs**: http://localhost:8000/redoc

## Step 4: Test Route Optimization Endpoints

Now that all services are running, test the route optimization feature.

### Check Health Status

```powershell
curl http://localhost:8000/api/traffic/route/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "Route Optimization API",
  "timestamp": "2024-01-15T10:30:00.123456"
}
```

### Find Cameras Along a Route

```powershell
# Example: Find cameras along a route in Singapore
$body = @{
    coordinates = @(
        @{ lat = 1.3521; lon = 103.8198 }  # Start: Orchard Road
        @{ lat = 1.2966; lon = 103.7764 }  # End: NUS
    )
    buffer_km = 0.5
} | ConvertTo-Json -Depth 10

curl -X POST "http://localhost:8000/api/traffic/route/cameras-along-route" `
  -H "Content-Type: application/json" `
  -d $body
```

Expected response:
```json
{
  "cameras_found": 3,
  "route_length_km": 8.45,
  "cameras": [
    {
      "camera_id": "1701",
      "location": {"lat": 1.3521, "lon": 103.8198},
      "distance_to_route_km": 0.12
    },
    ...
  ]
}
```

### Optimize Departure Time

```powershell
# Example: Optimize route from Orchard to NUS with 30-min original ETA
$body = @{
    route = @{
        coordinates = @(
            @{ lat = 1.3521; lon = 103.8198 }  # Orchard Road
            @{ lat = 1.2966; lon = 103.7764 }  # NUS
        )
    }
    original_eta_minutes = 30
    max_delay_minutes = 20
    buffer_km = 0.5
} | ConvertTo-Json -Depth 10

curl -X POST "http://localhost:8000/api/traffic/route/optimize" `
  -H "Content-Type: application/json" `
  -d $body
```

Expected response:
```json
{
  "best_departure": {
    "delay_minutes": 10,
    "updated_eta_minutes": 28,
    "average_ci": 0.35,
    "traffic_level": "LIGHT",
    "time_saved_minutes": 2,
    "confidence_score": 0.85
  },
  "route_info": {
    "cameras_analyzed": 3,
    "route_length_km": 8.45,
    "buffer_km": 0.5
  },
  "alternatives": [
    {
      "delay_minutes": 0,
      "updated_eta_minutes": 33,
      "average_ci": 0.55,
      "traffic_level": "MODERATE"
    },
    ...
  ]
}
```

## Complete Workflow Example

Here's a complete example showing the entire workflow:

### 1. Start All Services

```powershell
# Terminal 1: Start Redis
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend\app\services\trafficcams"
docker-compose up redis -d

# Terminal 2: Start CI Service
docker-compose up ci-service -d

# Terminal 3: Start FastAPI Backend
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend"
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Wait for Initial Data (Important!)

The CI service needs at least **one processing cycle** (2 minutes) to populate Redis with data before the route optimization API can work.

Check CI service logs:
```powershell
docker-compose logs -f ci-service
```

Wait until you see:
```
[INFO] Processing cycle 1/∞
[INFO] Stored results in Redis
```

### 3. Test the API

```powershell
# Health check
curl http://localhost:8000/api/traffic/route/health

# Optimize a route
$body = @{
    route = @{
        coordinates = @(
            @{ lat = 1.3521; lon = 103.8198 }
            @{ lat = 1.2966; lon = 103.7764 }
        )
    }
    original_eta_minutes = 30
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:8000/api/traffic/route/optimize" `
  -Method POST `
  -ContentType "application/json" `
  -Body $body
```

## Configuration Options

### CI Service Configuration

Edit `docker-compose.yml` to change CI service behavior:

```yaml
environment:
  # Processing interval (seconds)
  - LOOP_INTERVAL=120          # Process every 2 minutes
  
  # Storage backend
  - REPOSITORY_TYPE=redis      # Options: redis, csv, sql
  
  # Forecaster type
  - FORECASTER_TYPE=auto       # Options: simple, ml, auto
  
  # Redis connection
  - REDIS_HOST=redis
  - REDIS_PORT=6379
  - REDIS_DB=0
```

### Route Optimization Configuration

The route optimizer uses these default values (can be overridden in API requests):

- **Buffer distance**: 0.5 km (cameras within 500m of route)
- **Forecast horizon**: 120 minutes
- **Analysis interval**: 10 minutes
- **Max delay**: 60 minutes (default, can be customized per request)

## Troubleshooting

### Problem: "Connection refused to Redis"

**Cause**: Redis is not running or not accessible.

**Solution**:
```powershell
# Check if Redis container is running
docker-compose ps

# Restart Redis
docker-compose restart redis

# Check Redis logs
docker-compose logs redis
```

### Problem: "No CI data available for cameras"

**Cause**: CI service hasn't run yet or is failing.

**Solution**:
```powershell
# Check CI service status
docker-compose ps ci-service

# Check CI service logs
docker-compose logs -f ci-service

# Restart CI service
docker-compose restart ci-service
```

### Problem: "No cameras found along route"

**Cause**: Route is outside Singapore or buffer distance is too small.

**Solution**:
- Ensure route coordinates are in Singapore (1.2° to 1.5° N, 103.6° to 104.0° E)
- Increase `buffer_km` parameter (try 1.0 or 2.0)
- Check available cameras in `train/data/cam_id_lat_lon.json`

### Problem: "Module not found" errors

**Cause**: Python dependencies not installed or PYTHONPATH not set.

**Solution**:
```powershell
# Reinstall dependencies
pip install -r requirements.txt

# Set PYTHONPATH
$env:PYTHONPATH = "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend"
```

### Problem: Docker containers not starting

**Cause**: Docker daemon not running or port conflicts.

**Solution**:
```powershell
# Check Docker is running
docker ps

# Check for port conflicts
netstat -ano | findstr :6379  # Redis port
netstat -ano | findstr :8000  # FastAPI port

# Stop conflicting services or change ports in docker-compose.yml
```

## Stopping Services

### Stop All Docker Services

```powershell
cd "c:\NTU Stuffs\Modules\Y2S1\SC2006\triptally\TripTally\backend\app\services\trafficcams"
docker-compose down
```

### Stop FastAPI Backend

Press `Ctrl+C` in the terminal running uvicorn.

### Clean Up (Remove Data)

```powershell
# Stop and remove containers + volumes
docker-compose down -v

# This will delete all CI data in Redis
```

## Next Steps

- **Integration Testing**: Run `python test_route_optimization.py` to verify all components
- **Load Testing**: Use tools like Apache Bench or Locust to test under load
- **Production Deployment**: Consider using Kubernetes or cloud services
- **Monitoring**: Set up logging and metrics (Prometheus, Grafana)
- **Documentation**: Review `TECHNICAL_REPORTS_*.md` files for architecture details

## Additional Resources

- **API Documentation**: http://localhost:8000/docs
- **Architecture**: `TECHNICAL_REPORTS_ARCHITECTURE.md`
- **Design Patterns**: `DESIGN_PATTERNS_IMPLEMENTATION.md`
- **Camera Loading**: `CAMERA_LOADING.md`
- **Repository Pattern**: See `ports/` and `adapters/` directories
- **FastAPI Docs**: https://fastapi.tiangolo.com/

## Quick Reference

| Service | Port | Purpose |
|---------|------|---------|
| Redis | 6379 | Storage for CI values and forecasts |
| CI Service | N/A | Background processing (Docker container) |
| FastAPI | 8000 | REST API endpoints |

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/traffic/route/health` | GET | Health check |
| `/api/traffic/route/cameras-along-route` | POST | Find cameras near route |
| `/api/traffic/route/optimize` | POST | Optimize departure time |
| `/docs` | GET | Interactive API documentation |

| File | Purpose |
|------|---------|
| `main.py` | CI service entry point |
| `app/main.py` | FastAPI application |
| `docker-compose.yml` | Docker orchestration |
| `train/data/cam_id_lat_lon.json` | Camera metadata (90 cameras) |
| `requirements.txt` | Python dependencies |
